--Raporlar

--1. En çok gezilen yer/yerler neresidir? +++

		select top 1 BolgeId1,g.GidilecekYer,sum(GidilenYerler) as [Ziyaret Edilme Sayisi] 
		from (			select BolgeId1, count(*) as GidilenYerler from Tur group by BolgeId1  union all
						select BolgeId2, count(*) as GidilenYerler from Tur group by BolgeId2 union  all
						select BolgeId3, count(*) as GidilenYerler from Tur  group by BolgeId3 )
		as toplamSayý 
						join GidilecekYer g on g.BolgeId=toplamSayý.BolgeId1	
		where toplamSayý.BolgeId1 is not null 
		group by  toplamSayý.BolgeId1,g.GidilecekYer 
		order by [Ziyaret Edilme Sayisi] desc

		--select * from tur
				
				-- !!! ACIKLAMA 
				-- bu sorguda tur tablosunda 3 bolumde yer alan gidilecek yerleri 1 tablo yapmak için union all ile birleþtirme yaptým
				-- sonra bana bolgeid nin isimlerini almak için GidilecekYer ile join iþlemi yaptým
				-- bu sorgunun son kýsmýnda da bolgeýd olarak gruplama yaptým ve gidilenyerlerin sum ile toplama iþlemi ile toplam ziyaret sayýsýni aldým
				-- en son [Ziyaret Edilme Sayisi] ný desc olarak sýralama yaptým ve top 1 ile en fazla olaný buldum
 	
--2. Aðustos ayýnda en çok çalýþan rehber/rehberler kimdir/kimlerdir? +++
		

		select top 1  r.Ad +' '+r.Soyad as [Austos'ta en fazla calisan] ,count (*) as Calisma_Sayisi   
		from rehber r join satis s on r.RehberId= s.RehberId
					  join Tur t on s.TurId= t.TurId
		where DATENAME(MONTH,t.TurTarihi)='august'
		group by r.Ad +' '+r.Soyad
		order by Calisma_Sayisi desc

				--!!! ACIKLAMA
				-- bu soruda Satis, Rehber ve Tur tablolarýný join ile baðlantý kurdum
				--sonra rehber isim soyisim olarak bir grup yaptým bu gruptan bize rehberlerin hangi turlara rehber olarak katýldýðý bilgsi gelir
				-- bende  rehber ile grup yaparak turlarýn sayýlarýný count ile aldým sonra koþulu August olanlar diye filtreleme yaptým
				-- en sonda ters sýralama ile top 1 i aldým 


--3. Kadýn turistlerin gezdiði yerleri, toplam ziyaret edilme sayýlarýyla beraber listeleyin +++
		-- 1 adým 
			-- bu kýsýmda kadýn turistler kimler ve hangi tura katýlmýþlar bolge isimleri neler liste olarak gormek için yapýlan sorgu
			select t.Ad,t.Soyad,t.Cinsiyet,tur.TurAdi,g1.GidilecekYer as [1 yer],g2.GidilecekYer as [2. yer]
			from Turist t join Satis s on t.TuristId =s.TuristId
								join Tur tur on s.TurId=tur.TurId
								join GidilecekYer g1 on g1.BolgeId =tur.BolgeId1
								join GidilecekYer g2 on g2.BolgeId =tur.BolgeId2
			where Cinsiyet='Kadýn' 

			--2 adým
			/* bu sorguda bir geçici tablo oluþturdum bu tabloda bolgeid, turid ve bolgeye gitmesayýsý olarak 3 column ekledim
			oluþturduðum tablo ile turist,satýþ ve gidilecekyer tablolorýný join iþlemi yaptým
			koþul ile fitreleme yaptýmce en son gidilecekyere gore bir gruplama yaparak bolgelere(gidilecekyer)ziyaret sayýlarýný sum ile buldum
			buradaki ziyaret sayýlarý Kadýnlarýn ziyaret ettikleri sayýdýr
			
			*/

				select t.Cinsiyet,g.GidilecekYer,sum(tsayisi.gitmeSayisi) as[Ziyaret sayilari] from turist t 
								join Satis s on s.TuristId =t.TuristId
								join ( 		select  newTablo.BolgeId1,COUNT(*) as gitmeSayisi,TurId from (
													select TurId, TurAdi,BolgeId1,TurTarihi from tur union
													select TurId, TurAdi,BolgeId2,TurTarihi from tur union
													select turýd, TurAdi,BolgeId3,TurTarihi from tur)
											as newTablo
											where BolgeId1 is not null
											group by newTablo.BolgeId1,TurId ) tsayisi on tsayisi.TurId=s.TurId
								join GidilecekYer g on g.BolgeId=tsayisi.BolgeId1

				where t.Cinsiyet='Kadýn'
				group by g.GidilecekYer,t.Cinsiyet

				-- 3 adým burada 1 soruda elde ettiðimiz toplam ziyaret sayýlarýný sutun olarak ekleme yaptým
					-- hem toplam zýyaret hem de kadýnlarýn ziyaret sayýlarýný ayrý columnlarda 2 sorguyu join yaparak gösterdim
					
				select new1.Cinsiyet,new1.GidilecekYer,new1.[Kadýnlarýn Ziyaret sayilari],new2.[Toplam Ziyaret Edilme Sayisi] 
				from ( select t.Cinsiyet,g.GidilecekYer,sum(tsayisi.gitmeSayisi) as[Kadýnlarýn Ziyaret sayilari] 
						from turist t	join Satis s on s.TuristId =t.TuristId
										join ( 	select  new1.BolgeId1,COUNT(*) as gitmeSayisi,TurId 
												from (	select TurId, TurAdi,BolgeId1,TurTarihi from tur union
														select TurId, TurAdi,BolgeId2,TurTarihi from tur union
														select turýd, TurAdi,BolgeId3,TurTarihi from tur  )
												as new1
												where BolgeId1 is not null
												group by new1.BolgeId1,TurId 
											  ) tsayisi on tsayisi.TurId=s.TurId
										join GidilecekYer g on g.BolgeId=tsayisi.BolgeId1
				where t.Cinsiyet='Kadýn'
				group by g.GidilecekYer,t.Cinsiyet
					 ) as new1 			
					join (	select  BolgeId1,g.GidilecekYer,sum(GidilenYerler) as [Toplam Ziyaret Edilme Sayisi] 
							from (	select BolgeId1, count(*) as GidilenYerler from Tur group by BolgeId1  union all
									select BolgeId2, count(*) as GidilenYerler from Tur group by BolgeId2 union  all
									select BolgeId3, count(*) as GidilenYerler from Tur  group by BolgeId3 
								 ) as toplamSayý 
							join GidilecekYer g on g.BolgeId=toplamSayý.BolgeId1	
							where toplamSayý.BolgeId1 is not null 
							group by  toplamSayý.BolgeId1,g.GidilecekYer 
						) as new2 on new2.GidilecekYer= new1.GidilecekYer
		

--4. Ýngiltere’den gelip de Kýz Kulesi’ni gezen turistler kimlerdir? +++
		
					select t.Ad,t.Soyad,t.GeldigiUlke,tur.TurAdi from turist t	
								join Satis s on s.TuristId =t.TuristId
								join Tur tur on s.TurId =tur.TurId
					where GeldigiUlke='English' and TurAdi  like '%kýz kulesi%'

					--!!! ACIKLAMA
					/* bu sorguda turist satis tur tablolorýný join iþlemmi yaptým sonra 2 koþul ile filtreleme yaparak turist bilgilerini aldým
					
					*/


--5. Gezilen yerler hangi yýlda kaç defa gezilmiþtir? +++
		
	       -- select * from tur

			select year(TurTarihi) as ZiyaretYili,g.GidilecekYer,count(*) as ZiyaretSayisi
			from (	select bolgeId1,TurTarihi  from Tur union all  
					select bolgeId2,TurTarihi  from Tur union all
					select bolgeId3,TurTarihi  from Tur
						)
			as newTablo  
					join GidilecekYer g on g.BolgeId=newTablo.BolgeId1
			group by year(newTablo.TurTarihi),g.GidilecekYer

			--!!! ACIKLAMA
			-- bir unýon iþlemi ile bolgeid(1,2,3) olan kýsýmlarý alt alta olacak þekilde geçici bir tablo oluþtururuz sorgu ile 
			--oluþan tablo ile gidilecekyer tablosunu join iþlemi yaptim 
			-- en son yýllara gore  gidilecekyeri birlikte grup iþlemi yaptým buradan count keywordu bize zýyaret sayýsýný verir

			
		

		


--6. 2’den fazla tura rehberlik eden rehberlerin en çok tanýttýklarý yerler nelerdir? +++
			select * from Rehber --rehber id lerini gormek için
			select RehberId,TurId from Satis -- hangi rehber hangi tura rehberlik etmiþ gormek için
			select * from tur --tur da gidilen yerleri gormek için

			--!!! ACIKLAMA 
			-- 1 adýmda yeni bir tablo ile rehber tablosuna benzer ama rehberlerin katýldýklarý rehberlik yapma sayýlarýný da yazan column ekleyerek bir tablo oluþturdum 
				select * from(
								select r.rehberId, r.Ad+r.Soyad as FullName,count(s.TurId) as RehberlikSayisi 
								from satis s join Rehber r on s.RehberId=r.RehberId
											 join Tur tur on tur.TurId=s.TurId	
								group by r.RehberId,r.Ad +r.Soyad 
							 ) 	as newRehber
			--2 adým 
			/*  bu adýmda gidilecekyer tablosundan gidilecek yerin adini, satýþ tablosu ile newrehber tablosundan rehberid ve rehberlikSAyýsýný almak için joinleme iþlemi yaptým
				olusan sorgu çýktýsýndan koþul ile filtreleme iþlemi yaparýz sonra elimizdeký çýktýyi gruplama(gidilecekyer) ile yaptýðýmýzda rehberlerin gittikeri yerlerin 
				sayýsýný alýrýz en sonda buyukten-kucuge sýralama ile en fazla olan deðeri alrak sonuc elde ederiz
			
			*/
				select top 1  g.GidilecekYer,count(*) as [Tanýttýklar yerin sayýsý]
				from (	select TurAdi, turId, bolgeId1,TurTarihi  from Tur union all
						select TurAdi, turId, bolgeId2,TurTarihi  from Tur union all
						select TurAdi, turId, bolgeId3,TurTarihi  from Tur
						) as newTablo 
										join GidilecekYer g on g.BolgeId=newTablo.BolgeId1
										join Satis s on s.TurId =newTablo.TurId
										join   (	
												select r.rehberId, r.Ad+r.Soyad as FullName,count(s.TurId) as RehberlikSayisi 
												from satis s join Rehber r on s.RehberId=r.RehberId
															 join Tur tur on tur.TurId=s.TurId	
												group by r.RehberId,r.Ad +r.Soyad
												) as newRehber on newRehber.RehberId =s.RehberId	
				where newRehber.RehberlikSayisi>2
				group by g.GidilecekYer 
				order by [Tanýttýklar yerin sayýsý] desc  
						

			



								
		
		
--7. Ýtalyan turistler en çok nereyi gezmiþtir? +++
		-- 1 adým --> italyan turist sorgusunda kimse yok 
			select * from Turist where Uyruk ='Italy'

		-- 2 adým --> bende sorguyu English þeklinde test ettim
		 -- bu adýmda ingilz turistleri ve katýldýklarý turadlarný listeledim
			select t.Ad,t.Soyad,t.Uyruk,tur.TurAdi from turist t 
								join Satis s on s.TuristId =t.TuristId
								join Tur tur on s.TurId =tur.TurId
			where Uyruk='english' 

		-- 3 adým 
		/*
		 bu adýmda ihtiyacým olan satýs,turist,tur,gidilecekyer ve yeni bir tsayýsý adýnda tablo oluþturarak tablolarý join yaptým
		 tsayýsý ==> bu tablo da 3 tane column oluþturdum bunlar turid, o turda gidilen bolgeler ve gitme sayýlarý--
		tsayýsý tablosunu olluþturmak için içiçe subquery sorgu ile ulaþtým iç sorguda ismini toplamsayý2 ismini verdim bu oluþacak tablo sutunlarý
		turid, turadi,bolgeid dir burada 3 tane bolgeid(1,2,3) bunlarý toplamsayý2 tablosunda altalta listelemek istedim sonra bunlarý grup yapabilirim  
		þimdi elimde turid de gidilen bolgelerin gidilme sayýlarý var o zaman koþul ile ingiliz turistleri filtrelerim
		sonra gidilecekyerleri gruoplandýrýrým (bu gruplandýrma bolgeid ilede olur) bu þekilde grup yaptýðimda count ile gidilecekyerlerin gruplandýrma sayýlarýný elde ederim
		*/
			select top 1 t.Uyruk,g.GidilecekYer,sum(tsayisi.gitmeSayisi) as[Ziyaret sayilari] 
			from turist t 	join Satis s on s.TuristId =t.TuristId
							join Tur tur on tur.TurId =s.TurId
							join ( 	select  toplamsayi2.BolgeId,COUNT(*) as gitmeSayisi,TurId 
									from (	select TurId, TurAdi,BolgeId1 as BolgeId from tur union all
											select TurId, TurAdi,BolgeId2 as BolgeId from tur union all
											select turýd, TurAdi,BolgeId3 as BolgeId from tur
										 )	
									as toplamsayi2
									where BolgeId is not null
									group by toplamsayi2.BolgeId,TurId 
								 ) 
							as tsayisi on tsayisi.TurId=tur.TurId
							join GidilecekYer g on g.BolgeId=tsayisi.BolgeId
			where t.Uyruk='english' -- burasý istenen query de Italy olmalý
			group by g.GidilecekYer,t.Uyruk
			order by [Ziyaret sayilari] desc


--8. Kapalý Çarþý’yý gezen en yaþlý turist kimdir? +++

			select top 1 t.Ad,t.Soyad,t.Yas,tur.TurAdi 
			from turist t	join Satis s on s.TuristId =t.TuristId
							join Tur tur on s.TurId =tur.TurId
			where TurAdi like '%Kapalýçarþý%'
			order by yas desc

								--!!!
								/*
								bu sorguda tur adýnda  Kapalýçarþý bolge ismi olan yerleri secerek
								turistleri buldum sonra yas column'a gore desc sýralama yaptým 1 datayý aldým
								Not sýralama yaþ deðil doðum tarihine görede yazýlabilir 
								amacým sutun kýsmini computed column specification ayarý yapmaktý.
								*/


--9. Yunanistan’dan gelen Finlandiyalý turistin gezdiði yerler nerelerdir? +++

			select t.Ad,t.Soyad,t.GeldigiUlke,t.Uyruk,tur.TurAdi 
			from turist t	join Satis s on s.TuristId =t.TuristId
							join Tur tur on s.TurId =tur.TurId
			where t.GeldigiUlke='greek' and t.Uyruk ='finnish'

								--!!! ACIKLAMA
								/*
								bu sorguda turist tablosu ve tur tablosuna ihtiyacým var
								2 tane koþul ile sorgulama yaparak  
								Yunanistan’dan gelen Finlandiyalý turistin gezdiði yerleri buldum
								*/
							

--10. Dolmabahçe Sarayý’na en son giden turistler ve rehberi listeleyin. +++

			select top 1 concat (t.Ad,' ',t.Soyad) as Turist,tur.TurAdi,concat (r.Ad,' ',r.Soyad) as Rehber,tur.TurTarihi 
			from turist t		join Satis s on s.TuristId =t.TuristId
								join Tur tur on s.TurId =tur.TurId
								join Rehber r on r.RehberId=s.RehberId
			where TurAdi like '%Dolmabahçe%' order by tur.TurTarihi desc

				-- !!! ACIKLAMA
				/* bu sorguda turist tablosu Rehber tablosu ve Tur tablosu ihtiyacým var 
					birde bu toblolarýn baðlantý yeri olan satýs tablosunu joinledim extradan
					sonra bu cýkan tablodan koþul olarak turadýnda Dolmabahce varmý onu ekledim
				
				*/

		--FATURA ÝÞLEMLERÝ 

			select * from turist 
			--turist yas kriterlerinde 60 yas uzeri bulunmadýðý için test amaçlý 30 yas denedim

		select	trst.Ad+trst.Soyad as AdSoyad, concat (fatura,year(FaturaTarihi),MONTH(FaturaTarihi),day(FaturaTarihi),FaturaId) as Faturano,
				f.FaturaTarihi,t.TurAdi,
				sum(Ucret)*trst.indirim	 as Tutar
		from Fatura f	join Satis s on f.SatisId=s.SatisId 
						join  (select *,
									case
										when Yas >30 then 0.85  -- yas krýteriný test amaclý 30 yaptým
										when yas <30 then 1
										else 1
									end as indirim	
								from Turist
							   ) trst on trst.TuristId=s.TuristId
						join (	select TurId, TurAdi,BolgeId1 as BolgeId from tur union all
											select TurId, TurAdi,BolgeId2 as BolgeId from tur union all
											select turýd, TurAdi,BolgeId3 as BolgeId from tur
							 ) t on t.TurId =s.TurId
						join GidilecekYer g on g.BolgeId =t.BolgeId
		where FaturaId=2-- istenilen fatura talep koþulu
		group by	trst.Ad+trst.Soyad,t.TurAdi,f.FaturaTarihi,trst.indirim ,
					concat (fatura,year(FaturaTarihi),MONTH(FaturaTarihi),day(FaturaTarihi),FaturaId)
		

		-- Searched Case When


select *, 
		case
			when Yas >30 then 0.85
			when yas <30 then 1
			else 1
		end as indirim	
from Turist
